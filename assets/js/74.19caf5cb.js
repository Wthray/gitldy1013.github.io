(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{710:function(s,e,n){"use strict";n.r(e);var a=n(3),t=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"redis5-高可用集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#redis5-高可用集群"}},[s._v("#")]),s._v(" Redis5 高可用集群")]),s._v(" "),n("h2",{attrs:{id:"概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),n("p",[s._v("HA(High Available，高可用性群集)机集群系统简称，是保证业务连续性的有效解决方案，一般有两个或两个以上的节点，且分为活动节点及备用节点。通常把正在执 行业务的称为活动节点，而作为活动节点的一个备份的则称为备用节点。当活动节点出现问题，导致正在运行的业务（任务）不能正常运行时，备用节点此时就会侦测到，并立即接续活动节点来执行业务。从而实现业务的不中断或短暂中断。")]),s._v(" "),n("p",[s._v("Redis 一般以主/从方式部署（这里讨论的应用从实例主要用于备份，主实例提供读写）该方式要实现 HA 主要有如下几种方案：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("keepalived：")]),s._v(" 通过 keepalived 的虚拟 IP，提供主从的统一访问，在主出现问题时， 通过 keepalived 运行脚本将从提升为主，待主恢复后先同步后自动变为主，该方案的好处是主从切换后，应用程序不需要知道(因为访问的虚拟 IP 不变)，坏处是引入 keepalived 增加部署复杂性，在有些情况下会导致数据丢失")]),s._v(" "),n("li",[n("strong",[s._v("zookeeper：")]),s._v(" 通过 zookeeper 来监控主从实例， 维护最新有效的 IP， 应用通过 zookeeper 取得 IP，对 Redis 进行访问，该方案需要编写大量的监控代码")]),s._v(" "),n("li",[n("strong",[s._v("sentinel：")]),s._v(" 通过 Sentinel 监控主从实例，自动进行故障恢复，该方案有个缺陷：因为主从实例地址( IP & PORT )是不同的，当故障发生进行主从切换后，应用程序无法知道新地址，故在 Jedis2.2.2 中新增了对 Sentinel 的支持，应用通过 redis.clients.jedis.JedisSentinelPool.getResource() 取得的 Jedis 实例会及时更新到新的主实例地址")])]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/264650839c34e8a.png",alt:""}})]),s._v(" "),n("p",[n("strong",[s._v("注意：")]),s._v(" sentinel 是解决 HA 问题的，cluster 是解决主从复制问题的，不重复，并且经常一起用")]),s._v(" "),n("h2",{attrs:{id:"redis-sentinel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel"}},[s._v("#")]),s._v(" Redis Sentinel")]),s._v(" "),n("p",[s._v("Redis 集群可以在一组 redis 节点之间实现高可用性和 sharding。在集群中会有 1 个 master 和多个 slave 节点。当 master 节点失效时，应选举出一个 slave 节点作为新的 master。然而 Redis 本身 (包括它的很多客户端) 没有实现自动故障发现并进行主备切换的能力，需要外部的监控方案来实现自动故障恢复。")]),s._v(" "),n("p",[s._v("Redis Sentinel 是官方推荐的高可用性解决方案。它是 Redis 集群的监控管理工具，可以提供节点监控、通知、自动故障恢复和客户端配置发现服务。")]),s._v(" "),n("p",[n("img",{attrs:{src:"/images/db9cb6dd1d9defc.jpg",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"基于-docker-安装-redis-集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基于-docker-安装-redis-集群"}},[s._v("#")]),s._v(" 基于 Docker 安装 Redis 集群")]),s._v(" "),n("p",[s._v("2018 年 10 月 Redis 发布了稳定版本的 5.0 版本，推出了各种新特性，其中一点是放弃 Ruby 的集群方式，改为 使用 C 语言编写的 redis-cli 的方式，使集群的构建方式复杂度大大降低")]),s._v(" "),n("h3",{attrs:{id:"下载所需镜像"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#下载所需镜像"}},[s._v("#")]),s._v(" 下载所需镜像")]),s._v(" "),n("ul",[n("li",[s._v("Redis (5.x 测试有效)：docker pull redis")]),s._v(" "),n("li",[s._v("Redis Trib (用于创建集群)：docker pull zvelo/redis-trib")])]),s._v(" "),n("h3",{attrs:{id:"创建配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建配置文件"}},[s._v("#")]),s._v(" 创建配置文件")]),s._v(" "),n("p",[s._v("官方配置文件地址："),n("a",{attrs:{href:"http://download.redis.io/redis-stable/redis.conf",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://download.redis.io/redis-stable/redis.conf"),n("OutboundLink")],1),s._v(" ，我们部署 3 个节点，需要分别创建 3 个配置文件，路径如下")]),s._v(" "),n("ul",[n("li",[s._v("renode1：cluster/node1/redis.conf")]),s._v(" "),n("li",[s._v("renode2：cluster/node2/redis.conf")]),s._v(" "),n("li",[s._v("renode3：cluster/node3/redis.conf")])]),s._v(" "),n("p",[s._v("配置文件内容如下 ("),n("strong",[s._v("端口号不要重复")]),s._v(")")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bind 0.0.0.0\n# 关闭保护模式\nprotected-mode no\n# 绑定自定义端口\nport 6379\n# 禁止 Redis 后台运行\n# daemonize yes\npidfile /var/run/redis_6379.pid\n# 开启集群\n cluster-enabled yes\n # 集群的配置，配置文件首次启动自动生成\n cluster-config-file nodes_6379.conf\n # 开启 AOF\n # appendonly yes\n # 集群的 IP\n cluster-announce-ip 192.168.x.x\n # 集群的端口\n cluster-announce-port 6379\n # 集群的总线端口\n cluster-announce-bus-port 16379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h3",{attrs:{id:"创建资源配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建资源配置"}},[s._v("#")]),s._v(" 创建资源配置")]),s._v(" "),n("p",[s._v("docker-compose.yml 配置文件如下")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("version:  '3.1'\nservices:\n renode1:\n image: redis\n container_name: renode1\n restart: always\n ports:\n -  6379:6379\n -  16379:16379\n  volumes:\n  -  ./cluster/node1:/usr/local/etc/redis\n  command:\n  redis-server /usr/local/etc/redis/redis.conf\n  renode2:\n  image: redis\n  container_name: renode2\n  restart: always\n  ports:\n  -  6380:6380\n  -  16380:16380\n  volumes:\n  -  ./cluster/node2:/usr/local/etc/redis\n  command:\n  redis-server /usr/local/etc/redis/redis.conf\n  renode3:\n  image: redis\n  container_name: renode3\n  restart: always\n  ports:\n  -  6381:6381\n  -  16381:16381\n  volumes:\n  -  ./cluster/node3:/usr/local/etc/redis\n  command:\n  redis-server /usr/local/etc/redis/redis.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker-compose up -d\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"创建集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建集群"}},[s._v("#")]),s._v(" 创建集群")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker run --rm -it zvelo/redis-trib create 192.168.141.220:6379  192.168.141.220:6380  192.168.141.220:6381\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 输出如下\n>>>  Creating cluster\n>>>  Performing hash slots allocation on 3 nodes...\nUsing  3 masters:\n192.168.141.220:6379\n192.168.141.220:6380\n192.168.141.220:6381\n M:  9250c85592b7bb8a19636b90e4cf22590bd3334f  192.168.141.220:6379\n  slots:0-5460  (5461 slots) master\n M:  7373de7b44ee50a1e4f653bfba1bb808138e7e3a  192.168.141.220:6380\n  slots:5461-10922  (5462 slots) master\n M: ec7e6e4cdd142249e3aa83541044932655d75b66 192.168.141.220:6381\n  slots:10923-16383  (5461 slots) master\n Can I set the above configuration?  (type 'yes' to accept): yes\n >>>  Nodes configuration updated\n >>>  Assign a different config epoch to each node\n >>>  Sending CLUSTER MEET messages to join the cluster\n Waiting  for the cluster to join..\n >>>  Performing  Cluster  Check  (using node 192.168.141.220:6379)\n M:  9250c85592b7bb8a19636b90e4cf22590bd3334f  192.168.141.220:6379\n  slots:0-5460  (5461 slots) master\n M:  7373de7b44ee50a1e4f653bfba1bb808138e7e3a  192.168.141.220:6380\n  slots:5461-10922  (5462 slots) master\n M: ec7e6e4cdd142249e3aa83541044932655d75b66 192.168.141.220:6381\n  slots:10923-16383  (5461 slots) master\n [OK]  All nodes agree about slots configuration.\n >>>  Check  for open slots...\n >>>  Check slots coverage...\n [OK]  All  16384 slots covered.\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("h3",{attrs:{id:"验证集群是否成功"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证集群是否成功"}},[s._v("#")]),s._v(" 验证集群是否成功")]),s._v(" "),n("ul",[n("li",[s._v("交互式进入容器")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker exec -it renode1 /bin/bash\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("登录 Redis")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("redis-cli -p 6379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("查看集群信息")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("127.0.0.1:6379> cluster info\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 输出如下\ncluster_state:ok\ncluster_slots_assigned:16384\ncluster_slots_ok:16384\ncluster_slots_pfail:0\ncluster_slots_fail:0\ncluster_known_nodes:3\ncluster_size:3\ncluster_current_epoch:3\ncluster_my_epoch:1\ncluster_stats_messages_ping_sent:860\ncluster_stats_messages_pong_sent:870\ncluster_stats_messages_sent:1730\ncluster_stats_messages_ping_received:868\ncluster_stats_messages_pong_received:860\ncluster_stats_messages_meet_received:2\ncluster_stats_messages_received:1730\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("ul",[n("li",[s._v("查看集群节点")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("127.0.0.1:6379> cluster nodes\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 输出如下\nec7e6e4cdd142249e3aa83541044932655d75b66 192.168.141.220:6381@16381 master -  0  1569665070102  3 connected 10923-16383\n7373de7b44ee50a1e4f653bfba1bb808138e7e3a  192.168.141.220:6380@16380 master -  0  1569665069094  2 connected 5461-10922\n9250c85592b7bb8a19636b90e4cf22590bd3334f  192.168.141.220:6379@16379 myself,master -  0  1569665069000  1 connected 0-5460\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("ul",[n("li",[s._v("查看集群插槽")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("127.0.0.1:6379> cluster slots\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(' # 输出如下\n1) 1) (integer) 10923\n   2) (integer) 16383\n   3) 1) "192.168.141.220"\n      2) (integer) 6381\n      3) "ec7e6e4cdd142249e3aa83541044932655d75b66"\n2) 1) (integer) 5461\n   2) (integer) 10922\n   3) 1) "192.168.141.220"\n      2) (integer) 6380\n      3) "7373de7b44ee50a1e4f653bfba1bb808138e7e3a"\n3) 1) (integer) 0\n   2) (integer) 5460\n   3) 1) "192.168.141.220"\n      2) (integer) 6379\n      3) "9250c85592b7bb8a19636b90e4cf22590bd3334f"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h2",{attrs:{id:"基于-docker-安装-redis-sentinel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基于-docker-安装-redis-sentinel"}},[s._v("#")]),s._v(" 基于 Docker 安装 Redis Sentinel")]),s._v(" "),n("h3",{attrs:{id:"创建配置文件-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建配置文件-2"}},[s._v("#")]),s._v(" 创建配置文件")]),s._v(" "),n("p",[s._v("我们部署 3 个 Sentinel 节点，需要分别创建 3 个配置文件，路径如下")]),s._v(" "),n("ul",[n("li",[s._v("resentinel1：cluster/node1/sentinel.conf")]),s._v(" "),n("li",[s._v("resentinel2：cluster/node2/sentinel.conf")]),s._v(" "),n("li",[s._v("resentinel3：cluster/node3/sentinel.conf")])]),s._v(" "),n("p",[s._v("配置文件内容如下 ("),n("strong",[s._v("端口号不要重复")]),s._v(")")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("    bind 0.0.0.0\n    port 26379\n    dir /tmp\n    # 自定义集群名，其中 192.168.141.220 为 Redis Master 的 IP，6379 为 Redis Master 的端口，2 为最小投票数（因为有 3 台 Sentinel 所以可以设置成 2）\n    sentinel monitor rmaster 192.168.141.220  6379  2\n    sentinel down-after-milliseconds rmaster 30000\n    sentinel parallel-syncs rmaster 1\n    sentinel failover-timeout rmaster 180000\n    sentinel deny-scripts-reconfig yes\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h3",{attrs:{id:"创建资源配置-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建资源配置-2"}},[s._v("#")]),s._v(" 创建资源配置")]),s._v(" "),n("p",[s._v("docker-compose.yml 配置文件如下")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("version:  '3.1'\nservices:\n resentinel1:\n image: redis\n container_name: resentinel1\n ports:\n -  26379:26379\n command: redis-sentinel /usr/local/etc/redis/sentinel.conf\n volumes:\n  -  ./cluster/node1/sentinel.conf:/usr/local/etc/redis/sentinel.conf\n  resentinel2:\n  image: redis\n  container_name: resentinel2\n  ports:\n  -  26380:26380\n  command: redis-sentinel /usr/local/etc/redis/sentinel.conf\n  volumes:\n  -  ./cluster/node2/sentinel.conf:/usr/local/etc/redis/sentinel.conf\n  resentinel3:\n  image: redis\n  container_name: resentinel3\n  ports:\n  -  26381:26381\n  command: redis-sentinel /usr/local/etc/redis/sentinel.conf\n  volumes:\n  -  ./cluster/node3/sentinel.conf:/usr/local/etc/redis/sentinel.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("h3",{attrs:{id:"验证集群是否成功-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证集群是否成功-2"}},[s._v("#")]),s._v(" 验证集群是否成功")]),s._v(" "),n("ul",[n("li",[s._v("交互式进入容器")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker exec -it resentinel1 /bin/bash\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("登录 Redis Sentinel")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("redis-cli -p 26379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("查看集群 Master 信息")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("127.0.0.1:26379> sentinel master rmaster\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 输出如下\n 1)  "name"\n 2)  "rmaster"\n 3)  "ip"\n 4)  "192.168.141.220"\n 5)  "port"\n 6)  "6379"\n 7)  "runid"\n 8)  "30055483aeb9d75f35c0046aaec03440731e3e88"\n 9)  "flags"\n10)  "master"\n11)  "link-pending-commands"\n12)  "0"\n13)  "link-refcount"\n14)  "1"\n15)  "last-ping-sent"\n16)  "0"\n17)  "last-ok-ping-reply"\n18)  "413"\n19)  "last-ping-reply"\n20)  "413"\n21)  "down-after-milliseconds"\n22)  "30000"\n23)  "info-refresh"\n24)  "2878"\n25)  "role-reported"\n26)  "master"\n27)  "role-reported-time"\n28)  "143537"\n29)  "config-epoch"\n30)  "0"\n31)  "num-slaves"\n32)  "0"\n33)  "num-other-sentinels"\n34)  "2"\n35)  "quorum"\n36)  "2"\n37)  "failover-timeout"\n38)  "180000"\n39)  "parallel-syncs"\n40)  "1"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);